<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chess Opening Trainer V2.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        /* =========================================
           CORE STYLES (Mobile First)
           ========================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 120px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .beta-tag {
            background: #8b5cf6;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 8px;
        }

        .header p { color: #94a3b8; font-size: 0.875rem; }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-top: 20px;
            margin-bottom: 12px;
        }

        /* =========================================
           CARDS & LISTS
           ========================================= */
        .card {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .card:hover, .card:active {
            background: rgba(71, 85, 105, 0.5);
            border-color: #475569;
        }

        .card h3 { font-size: 1.125rem; margin-bottom: 6px; }
        .card p { color: #94a3b8; font-size: 0.875rem; }

        .card .moves {
            font-family: monospace;
            color: #fbbf24;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .color-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
        }

        .color-badge.white { background: #fbbf24; color: #1e293b; }
        .color-badge.black { background: #475569; color: #e2e8f0; }

        .card-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            background: rgba(100, 116, 139, 0.3);
            border: none;
            color: #94a3b8;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .edit-btn:hover { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .delete-btn:hover { background: rgba(239, 68, 68, 0.3); color: #f87171; }

        /* =========================================
           SCREENS & NAV
           ========================================= */
        .screen { display: none; }
        .screen.active { display: block; }

        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(71, 85, 105, 0.5);
            border: 1px solid #475569;
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            padding: 14px 20px;
            margin-bottom: 16px;
            min-height: 50px;
        }

        .nav-btn:hover { background: rgba(71, 85, 105, 0.7); }

        /* =========================================
           TRAINER UI
           ========================================= */
        .move-history {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .move-history-inner { display: flex; gap: 8px; flex-wrap: wrap; }

        .move-tag {
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: monospace;
            white-space: nowrap;
        }

        .move-tag.white-move { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .move-tag.black-move { background: rgba(71, 85, 105, 0.5); color: #cbd5e1; }
        .move-tag.choice { border: 1px solid #fbbf24; }

        .current-move-card {
            background: #334155;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .move-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .move-dot { width: 14px; height: 14px; border-radius: 50%; }
        .move-dot.your-move { background: #fbbf24; box-shadow: 0 0 12px rgba(251, 191, 36, 0.4); }
        .move-dot.opponent-move { background: #64748b; }

        .move-label span { font-weight: 600; font-size: 0.9rem; }
        .move-label span.your-move { color: #fbbf24; }
        .move-label span.opponent-move { color: #94a3b8; }

        .current-move {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
        }

        .current-move.opponent { background: linear-gradient(135deg, #475569 0%, #334155 100%); }
        .current-move h2 { font-family: monospace; font-size: 1.6rem; color: #1e293b; }
        .current-move.opponent h2 { color: #e2e8f0; }

        .explanation { color: #cbd5e1; font-size: 1rem; line-height: 1.6; }

        /* === Transposition Styles (New) === */
        .transposition-badge {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid #8b5cf6;
            border-radius: 10px;
            padding: 12px 14px;
            margin-top: 16px;
            font-size: 0.9rem;
            color: #c4b5fd;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .transposition-badge:hover { background: rgba(139, 92, 246, 0.25); }

        .transposition-list {
            margin-top: 8px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .transposition-list.visible { display: block; }

        .transposition-item {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            font-size: 0.9rem;
            color: #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .transposition-item:last-child { border-bottom: none; }
        .transposition-item:hover { background: rgba(139, 92, 246, 0.1); }
        .transposition-item .meta { font-size: 0.75rem; color: #94a3b8; }
        .transposition-item .jump-icon { color: #a78bfa; font-size: 1.1rem; }

        /* Options & Controls */
        .options-section { margin-top: 24px; }
        .options-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            color: #94a3b8;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .option-btn {
            width: 100%;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #475569;
            border-radius: 14px;
            padding: 18px 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: #e2e8f0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .option-btn:hover { background: rgba(71, 85, 105, 0.6); border-color: #64748b; }
        .option-btn .move-text { font-family: monospace; font-size: 1.2rem; font-weight: 600; }
        .option-btn .label {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-left: 10px;
            background: #475569;
        }
        .option-btn .label.main { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .option-btn .label.blunder { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .option-btn .arrow { color: #64748b; font-size: 1.4rem; }

        /* Choices Grid */
        .choices-grid { display: grid; gap: 12px; margin-bottom: 16px; }
        .choice-card {
            background: rgba(51, 65, 85, 0.3);
            border: 2px solid;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            position: relative;
        }

        .choice-card:hover { transform: scale(1.02); }
        .choice-card.red { border-color: rgba(239, 68, 68, 0.5); }
        .choice-card.blue { border-color: rgba(59, 130, 246, 0.5); }
        .choice-card.purple { border-color: rgba(168, 85, 247, 0.5); }
        .choice-card.green { border-color: rgba(34, 197, 94, 0.5); }
        
        .choice-card h4 { font-family: monospace; font-size: 1.125rem; margin-bottom: 4px; }
        .choice-card.red h4 { color: #f87171; }
        .choice-card.blue h4 { color: #60a5fa; }
        .choice-card.purple h4 { color: #c084fc; }
        .choice-card.green h4 { color: #4ade80; }
        
        .choice-card .name { font-weight: 600; font-size: 0.875rem; margin-bottom: 4px; }
        .choice-card .style { font-size: 0.75rem; color: #94a3b8; }

        /* End State & Tips */
        .end-card { text-align: center; padding: 40px 20px; }
        .end-card .icon { font-size: 3.5rem; margin-bottom: 16px; }
        .end-card h3 { font-size: 1.3rem; margin-bottom: 8px; }
        .end-card p { color: #94a3b8; }

        .controls { display: flex; gap: 12px; margin-top: 24px; }
        .control-btn {
            flex: 1; padding: 16px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer; min-height: 54px;
        }
        .control-btn.secondary { background: #475569; color: #e2e8f0; }
        
        .progress-dots { display: flex; justify-content: center; gap: 6px; margin-top: 24px; }
        .progress-dot { width: 10px; height: 10px; border-radius: 50%; background: #334155; }
        .progress-dot.active { background: #fbbf24; }
        
        .tip-box {
            background: rgba(30, 41, 59, 0.5); border: 1px solid #334155;
            border-radius: 12px; padding: 14px; margin-top: 24px;
            font-size: 0.85rem; color: #94a3b8; text-align: center;
        }

        /* Standard Buttons */
        .btn {
            width: 100%; padding: 18px 24px; border-radius: 14px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            text-align: center; border: none; min-height: 58px; margin-bottom: 12px;
        }
        .btn-primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .btn-secondary { background: rgba(71, 85, 105, 0.5); border: 1px solid #475569; color: #e2e8f0; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; }
        .btn-row { display: flex; gap: 12px; }
        .btn-row .btn { flex: 1; }

        /* =========================================
           BUILDER UI
           ========================================= */
        .builder-section {
            background: rgba(30, 41, 59, 0.5); border: 1px solid #334155;
            border-radius: 16px; padding: 20px; margin-bottom: 16px;
        }
        .builder-section h3 { font-size: 0.9rem; color: #94a3b8; margin-bottom: 16px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.85rem; color: #94a3b8; margin-bottom: 8px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 16px; background: #1e293b;
            border: 1px solid #334155; border-radius: 12px; color: #e2e8f0; font-size: 1.1rem;
        }
        .form-group input:focus { outline: none; border-color: #fbbf24; }

        /* Color Toggle */
        .color-toggle { display: flex; gap: 12px; }
        .color-option {
            flex: 1; padding: 16px; border-radius: 12px; text-align: center;
            cursor: pointer; font-weight: 600; min-height: 56px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .color-option.white { background: rgba(251, 191, 36, 0.1); border: 2px solid rgba(251, 191, 36, 0.3); color: #fbbf24; }
        .color-option.white.selected { background: rgba(251, 191, 36, 0.2); border-color: #fbbf24; }
        .color-option.black { background: rgba(100, 116, 139, 0.1); border: 2px solid rgba(100, 116, 139, 0.3); color: #94a3b8; }
        .color-option.black.selected { background: rgba(100, 116, 139, 0.2); border-color: #94a3b8; }

        /* Style Colors */
        .style-colors { display: flex; gap: 10px; flex-wrap: wrap; }
        .style-color {
            flex: 1; min-width: 70px; padding: 12px 8px; border-radius: 10px;
            text-align: center; cursor: pointer; font-weight: 600; font-size: 0.75rem;
            border: 2px solid transparent;
        }
        .style-color.red { background: rgba(239, 68, 68, 0.1); color: #f87171; }
        .style-color.red.selected { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .style-color.blue { background: rgba(59, 130, 246, 0.1); color: #60a5fa; }
        .style-color.blue.selected { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
        .style-color.purple { background: rgba(168, 85, 247, 0.1); color: #c084fc; }
        .style-color.purple.selected { background: rgba(168, 85, 247, 0.2); border-color: #a855f7; }
        .style-color.green { background: rgba(34, 197, 94, 0.1); color: #4ade80; }
        .style-color.green.selected { background: rgba(34, 197, 94, 0.2); border-color: #22c55e; }

        /* Builder Position & Responses */
        .position-card {
            background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 14px; padding: 18px; margin-bottom: 16px;
        }
        .position-card.opponent { background: rgba(100, 116, 139, 0.1); border-color: rgba(100, 116, 139, 0.3); }
        .position-label { font-size: 0.75rem; text-transform: uppercase; color: #fbbf24; margin-bottom: 8px; }
        .position-card.opponent .position-label { color: #94a3b8; }
        .position-move { font-family: monospace; font-size: 1.4rem; font-weight: 700; color: #e2e8f0; }

        .path-display {
            background: #1e293b; border-radius: 10px; padding: 12px 14px;
            margin-bottom: 16px; font-size: 0.85rem; color: #64748b;
            overflow-x: auto; white-space: nowrap;
        }
        .path-display .current { color: #fbbf24; font-weight: 600; }

        .response-list { margin-bottom: 16px; }
        .response-item {
            background: rgba(51, 65, 85, 0.5); border: 1px solid #475569;
            border-radius: 14px; padding: 18px 20px; margin-bottom: 10px;
            cursor: pointer; display: flex; align-items: center; min-height: 64px;
        }
        .response-item .move { font-family: monospace; font-size: 1.15rem; font-weight: 600; color: #cbd5e1; flex: 1; }
        .response-item .tag { background: #475569; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; margin-right: 12px; }

        .your-response-card {
            background: rgba(251, 191, 36, 0.1); border: 2px solid rgba(251, 191, 36, 0.4);
            border-radius: 14px; padding: 18px 20px; margin-bottom: 16px;
            cursor: pointer; display: flex; align-items: center; min-height: 64px;
        }
        .your-response-card .move { font-family: monospace; font-size: 1.15rem; font-weight: 600; color: #fbbf24; flex: 1; }

        .empty-state { text-align: center; padding: 40px 20px; color: #64748b; }
        .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }

        /* Forms & Toggles */
        .add-form {
            background: rgba(34, 197, 94, 0.05); border: 2px dashed rgba(34, 197, 94, 0.3);
            border-radius: 14px; padding: 20px;
        }
        .add-form.choice-form { background: rgba(168, 85, 247, 0.05); border-color: rgba(168, 85, 247, 0.3); }
        .add-form-title { font-size: 0.85rem; color: #4ade80; font-weight: 600; margin-bottom: 16px; }
        .add-form.choice-form .add-form-title { color: #c084fc; }

        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #334155; margin-bottom: 14px; }
        .toggle-switch {
            position: relative; width: 50px; height: 28px; background: #475569;
            border-radius: 14px; cursor: pointer; transition: background 0.2s;
        }
        .toggle-switch.active { background: #8b5cf6; }
        .toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px;
            background: white; border-radius: 50%; transition: left 0.2s;
        }
        .toggle-switch.active::after { left: 25px; }

        .choice-fields { display: none; padding-top: 14px; border-top: 1px solid #334155; margin-top: 14px; }
        .choice-fields.visible { display: block; }

        .edit-explanation { margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155; }
        .edit-explanation textarea { min-height: 80px; resize: vertical; }

        /* Misc */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            flex: 1; padding: 14px; background: rgba(51, 65, 85, 0.3);
            border: 1px solid #334155; border-radius: 12px; color: #94a3b8;
            font-weight: 600; cursor: pointer; text-align: center;
        }
        .tab.active { background: rgba(251, 191, 36, 0.1); border-color: #fbbf24; color: #fbbf24; }
        
        .json-area {
            width: 100%; min-height: 180px; background: #0f172a; border: 1px solid #334155;
            border-radius: 12px; padding: 14px; color: #e2e8f0; font-family: monospace;
            font-size: 0.8rem; resize: vertical;
        }

        .delete-item-btn {
            background: rgba(239, 68, 68, 0.2); border: none; color: #f87171;
            width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
            font-size: 1.2rem; margin-right: 8px; flex-shrink: 0;
        }
        .choice-card .delete-item-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; font-size: 1rem; }

        /* Template Info */
        .template-info {
            background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px; padding: 12px; margin-bottom: 12px; font-size: 0.8rem; color: #93c5fd;
        }
        .template-info summary { cursor: pointer; font-weight: 600; margin-bottom: 8px; }
        .template-info ul { margin: 8px 0 0 16px; color: #94a3b8; }
        .template-info code { background: rgba(0,0,0,0.3); padding: 1px 4px; border-radius: 3px; color: #fbbf24; }

    </style>
</head>
<body>
    <div class="container">
        <div class="screen active" id="menuScreen">
            <div class="header">
                <h1>‚ôüÔ∏è Opening Trainer <span class="beta-tag">V2.2</span></h1>
                <p>Master your chess openings move by move</p>
            </div>
            <div id="openingsContainer"></div>
            <button class="btn btn-primary" onclick="showBuilder()">+ Create New Opening</button>
            <div class="btn-row" style="margin-top: 8px;">
                <button class="btn btn-secondary" onclick="triggerFileUpload()">üìÅ Upload JSON</button>
                <button class="btn btn-secondary" onclick="showUrlImport()">üîó Import URL</button>
            </div>
            <div id="urlImportSection" style="display:none; margin-top: 12px;">
                <div class="builder-section">
                    <h3>Import from URL</h3>
                    <div class="form-group">
                        <input type="text" id="importUrl" placeholder="https://raw.githubusercontent.com/...">
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-secondary" onclick="hideUrlImport()">Cancel</button>
                        <button class="btn btn-primary" onclick="importFromUrl()">Import</button>
                    </div>
                </div>
            </div>
            <input type="file" id="fileUploadInput" accept=".json" style="display:none" onchange="handleFileUpload(event)">
        </div>

        <div class="screen" id="trainerScreen">
            <button class="nav-btn" id="trainerBackBtn" onclick="handleTrainerBack()">‚Üê Back to Openings</button>
            <div class="header">
                <h1 id="openingTitle"></h1>
                <p id="openingSubtitle"></p>
            </div>
            <div class="move-history"><div class="move-history-inner" id="moveHistory"></div></div>
            <div class="current-move-card" id="currentMoveCard"></div>
            <div class="controls" id="controls"></div>
            <div class="progress-dots" id="progressDots"></div>
            <div class="tip-box">üí° <span id="tipText">Tap a move to continue</span></div>
        </div>

        <div class="screen" id="builderScreen">
            <button class="nav-btn" onclick="confirmExitBuilder()">‚Üê Back</button>
            <div class="header">
                <h1 id="builderTitle">üõ†Ô∏è Create Opening</h1>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('build')" id="tabBuild">Build</button>
                <button class="tab" onclick="switchTab('json')" id="tabJson">Import/Export</button>
            </div>

            <div id="buildTab">
                <div class="builder-section">
                    <h3>Opening Details</h3>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="openingName" placeholder="e.g., Italian Game">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="openingDesc" placeholder="e.g., Targets f7 weakness">
                    </div>
                    <div class="form-group">
                        <label>You Play As</label>
                        <div class="color-toggle">
                            <div class="color-option white selected" onclick="setColor('white')">‚ôî White</div>
                            <div class="color-option black" onclick="setColor('black')">‚ôö Black</div>
                        </div>
                    </div>
                </div>

                <div class="builder-section">
                    <h3>Moves</h3>
                    <div id="builderContent"></div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="previewOpening()">Preview</button>
                    <button class="btn btn-primary" id="saveBtn" onclick="saveOpening()">Save</button>
                </div>
                <button class="btn btn-secondary" id="downloadCurrentBtn" style="display:none; margin-top: 8px;" onclick="downloadCurrentOpening()">üì• Download JSON</button>
            </div>

            <div id="jsonTab" style="display:none">
                <div class="builder-section">
                    <h3>Import from JSON</h3>
                    <details class="template-info">
                        <summary>üìã JSON Schema Reference</summary>
                        <ul>
                            <li><code>name</code> - Opening name</li>
                            <li><code>color</code> - "white" or "black"</li>
                            <li><code>tree</code> - Recursive move structure</li>
                        </ul>
                        <p style="margin-top:8px;font-size:0.8rem;color:#fbbf24;">(Full reference same as V1.0)</p>
                    </details>
                    <textarea class="json-area" id="jsonIn" placeholder="Paste opening JSON here..."></textarea>
                    <button class="btn btn-primary" onclick="importJson()">Import</button>
                </div>
                <div class="builder-section">
                    <h3>Export Current / Template</h3>
                    <textarea class="json-area" id="jsonOut" readonly style="min-height:280px;"></textarea>
                    <button class="btn btn-secondary" onclick="copyJson()">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

<script>
// =====================================================
// DEFAULT DATA & TEMPLATES
// =====================================================
const DEFAULT_OPENINGS = {
    italian_game: {
        name: "Italian Game", color: "white", description: "Classic 1.e4 opening targeting f7", startingMoves: "1. e4 e5 2. Nf3 Nc6 3. Bc4",
        tree: { id: 'root', move: '1. e4', player: 'white', explanation: 'Control the center.', children: [
            { id: 'e5', move: '1... e5', player: 'black', label: 'Classical', response: {
                id: 'Nf3', move: '2. Nf3', player: 'white', explanation: 'Attack e5, develop knight.', children: [
                    { id: 'Nc6', move: '2... Nc6', player: 'black', label: 'Main', response: {
                        id: 'Bc4', move: '3. Bc4', player: 'white', explanation: 'Italian Game! Targets f7.', children: []
                    }}
                ]
            }}
        ]}
    }
};

const JSON_TEMPLATE_WHITE = {
    "_comment": "TEMPLATE FOR WHITE OPENINGS",
    "name": "New White Opening", "color": "white", "description": "", "startingMoves": "1. e4",
    "tree": { "id": "root", "move": "1. e4", "player": "white", "explanation": "Start here", "children": [] }
};

const JSON_TEMPLATE_BLACK = {
    "_comment": "TEMPLATE FOR BLACK OPENINGS",
    "name": "New Black Opening", "color": "black", "description": "", "startingMoves": "1. d4 d5",
    "tree": { "id": "root", "move": "1. d4", "player": "white", "explanation": "Opponent move", "children": [] }
};

const LABEL_OPTIONS = ['', 'Main Line', 'Sideline', 'Aggressive', 'Solid', 'Blunder!', 'Theoretical'];

// =====================================================
// STATE
// =====================================================
let OPENINGS = {};
let currentOpening = null;
let currentOpeningKey = null; // NEW: Track the key to fix self-reference bug
let currentPath = [];
let userColor = 'white';
let isPreviewMode = false;

// Builder
let builderColor = 'white';
let builderTree = null;
let builderPath = [];
let editingKey = null;

// The Brain (Transposition Map)
let transpositionMap = {};

// =====================================================
// INIT
// =====================================================
function init() {
    OPENINGS = JSON.parse(JSON.stringify(DEFAULT_OPENINGS));
    try {
        const del = JSON.parse(localStorage.getItem('deletedOp5') || '[]');
        del.forEach(k => delete OPENINGS[k]);
        const custom = JSON.parse(localStorage.getItem('customOp5') || '{}');
        Object.assign(OPENINGS, custom);
    } catch(e) {}
    
    rebuildTranspositionMap();
    renderMenu();
}

function saveStorage() {
    const custom = {};
    for (const [k, v] of Object.entries(OPENINGS)) {
        if (!DEFAULT_OPENINGS[k]) custom[k] = v;
    }
    localStorage.setItem('customOp5', JSON.stringify(custom));
    rebuildTranspositionMap();
}

// =====================================================
// CHESS INTELLIGENCE (THE BRAIN)
// =====================================================

function rebuildTranspositionMap() {
    if (typeof Chess === 'undefined') return;
    transpositionMap = {};
    Object.entries(OPENINGS).forEach(([key, op]) => {
        if (key === '_preview') return;
        const game = new Chess();
        analyzeNodeRecursive(op.tree, game, key, op.name, op.color);
    });
}

function analyzeNodeRecursive(node, game, key, name, color) {
    if (!node) return;
    const cleanMove = node.move.replace(/^\d+\.+/, '').trim();
    const moveResult = game.move(cleanMove);
    
    if (moveResult || node.id === 'root') {
        const fen = game.fen();
        if (!transpositionMap[fen]) transpositionMap[fen] = [];
        const exists = transpositionMap[fen].find(i => i.key === key);
        if (!exists) {
            transpositionMap[fen].push({ key: key, name: name, move: node.move, color: color });
        }
        const processChild = (childNode) => {
            if (!childNode) return;
            analyzeNodeRecursive(childNode, game, key, name, color);
            game.undo(); 
        };
        if (node.children) node.children.forEach(processChild);
        if (node.response) {
            if (node.response.isChoice && node.response.choices) {
                node.response.choices.forEach(processChild);
            } else {
                processChild(node.response);
            }
        }
        if (node.isChoice && node.choices) node.choices.forEach(processChild);
    }
}

function getCurrentFenFromPath(opening, pathIds) {
    if (typeof Chess === 'undefined') return null;
    const game = new Chess();
    let currentNode = opening.tree;
    let clean = currentNode.move.replace(/^\d+\.+/, '').trim();
    game.move(clean);
    for (const id of pathIds) {
        let foundNext = false;
        if (currentNode.children) {
            const child = currentNode.children.find(c => c.id === id);
            if (child) {
                clean = child.move.replace(/^\d+\.+/, '').trim();
                game.move(clean);
                currentNode = child;
                foundNext = true;
            }
        }
        if (!foundNext && currentNode.response) {
            if (currentNode.response.id === id) {
                clean = currentNode.response.move.replace(/^\d+\.+/, '').trim();
                game.move(clean);
                currentNode = currentNode.response;
                foundNext = true;
            } else if (currentNode.response.isChoice && currentNode.response.choices) {
                const choice = currentNode.response.choices.find(c => c.id === id);
                if (choice) {
                    clean = choice.move.replace(/^\d+\.+/, '').trim();
                    game.move(clean);
                    currentNode = choice;
                    foundNext = true;
                }
            }
        }
        if (!foundNext && currentNode.isChoice && currentNode.choices) {
            const choice = currentNode.choices.find(c => c.id === id);
            if (choice) {
                clean = choice.move.replace(/^\d+\.+/, '').trim();
                game.move(clean);
                currentNode = choice;
                foundNext = true;
            }
        }
    }
    return game.fen();
}

function getTranspositionHTML(currentKey) {
    if (typeof Chess === 'undefined') return '';
    let fen = null;
    let currentUserColor = userColor;

    if (document.getElementById('builderScreen').classList.contains('active')) {
        if (!builderTree) return '';
        const tempOp = { tree: builderTree, name: "BuilderTemp" };
        const ids = builderPath.map(step => step.id).filter(id => id); 
        fen = getCurrentFenFromPath(tempOp, ids);
        currentUserColor = builderColor;
        currentKey = editingKey || 'builder_temp';
    } else {
        if (!currentOpening) return '';
        fen = getCurrentFenFromPath(currentOpening, currentPath);
    }
    
    if (!fen) return '';
    const matches = transpositionMap[fen];
    if (!matches || matches.length < 1) return '';
    
    // BUG FIX: Filter out current opening key and duplicates
    const uniqueKeys = new Set();
    const others = matches.filter(m => {
        if (m.key === currentKey || m.key === 'builder_temp' || m.color !== currentUserColor) return false;
        if (uniqueKeys.has(m.key)) return false; // Prevent duplicates in list
        uniqueKeys.add(m.key);
        return true;
    });
    
    if (others.length === 0) return '';
    
    return `
        <div class="transposition-badge" onclick="toggleTranspositionList(this)">
            <span>üîÄ Found in <strong>${others.length} other(s)</strong></span>
            <span style="margin-left:auto;font-size:1.2rem;">‚ñæ</span>
        </div>
        <div class="transposition-list">
            ${others.map(o => `
                <div class="transposition-item" onclick="loadTransposition('${o.key}', '${fen.replace(/'/g, "\\'")}')">
                    <div>
                        <strong>${o.name}</strong>
                        <div class="meta">via ${o.move}</div>
                    </div>
                    <span class="jump-icon">‚ûú</span>
                </div>
            `).join('')}
        </div>
    `;
}

function toggleTranspositionList(el) {
    const list = el.nextElementSibling;
    list.classList.toggle('visible');
}

function loadTransposition(targetKey, targetFen) {
    const opening = OPENINGS[targetKey];
    if (!opening) return;
    const path = findPathToFenInOpening(opening, targetFen);
    
    if (!path && path.length === 0 && targetFen !== getStartFen()) {
         alert("Could not locate precise path to this position.");
         return;
    }
    if (document.getElementById('builderScreen').classList.contains('active')) {
        if(!confirm("Switching to " + opening.name + ". Unsaved changes will be lost.")) return;
    }
    startTraining(targetKey); 
    currentPath = path; 
    renderTrainer(); 
}

function findPathToFenInOpening(opening, targetFen) {
    if (typeof Chess === 'undefined') return [];
    const game = new Chess();
    let foundPath = null;
    
    function search(node, currentPath) {
        if (foundPath) return; 
        const clean = node.move.replace(/^\d+\.+/, '').trim();
        game.move(clean);
        if (game.fen() === targetFen) {
            foundPath = [...currentPath];
            game.undo();
            return;
        }
        const children = node.children || [];
        children.forEach(c => search(c, [...currentPath, c.id]));
        if (node.response) {
            if (node.response.isChoice && node.response.choices) {
                node.response.choices.forEach(c => search(c, [...currentPath, c.id]));
            } else {
                search(node.response, [...currentPath, node.response.id]); 
            }
        }
        if (node.isChoice && node.choices) {
            node.choices.forEach(c => search(c, [...currentPath, c.id]));
        }
        game.undo();
    }
    
    const root = opening.tree;
    const cleanRoot = root.move.replace(/^\d+\.+/, '').trim();
    game.move(cleanRoot);
    if (game.fen() === targetFen) return []; 
    if (root.children) root.children.forEach(c => search(c, [c.id]));
    return foundPath || [];
}

// =====================================================
// SCREENS & MENU
// =====================================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function goToMenu() {
    isPreviewMode = false;
    showScreen('menuScreen');
    renderMenu();
}

function renderMenu() {
    const c = document.getElementById('openingsContainer');
    const w = Object.entries(OPENINGS).filter(([k, o]) => o.color === 'white' && k !== '_preview');
    const b = Object.entries(OPENINGS).filter(([k, o]) => o.color === 'black' && k !== '_preview');
    let h = '';
    if (w.length) { h += '<p class="section-title">White Openings</p>'; w.forEach(([k, o]) => h += openingCard(k, o)); }
    if (b.length) { h += '<p class="section-title">Black Openings</p>'; b.forEach(([k, o]) => h += openingCard(k, o)); }
    c.innerHTML = h;
}

function openingCard(k, o) {
    return `<div class="card" onclick="startTraining('${k}')">
        <h3>${o.name}<span class="color-badge ${o.color}">${o.color[0].toUpperCase() + o.color.slice(1)}</span></h3>
        <p>${o.description}</p>
        <div class="moves">${o.startingMoves}</div>
        <div class="card-actions">
            <button class="edit-btn" onclick="event.stopPropagation();downloadOpening('${k}')" title="Download JSON">üì•</button>
            <button class="edit-btn" onclick="event.stopPropagation();editOpening('${k}')" title="Edit">‚úèÔ∏è</button>
            <button class="delete-btn" onclick="event.stopPropagation();deleteOpening('${k}')" title="Delete">üóë</button>
        </div>
    </div>`;
}

function deleteOpening(k) {
    if (!confirm('Delete "' + (OPENINGS[k]?.name || k) + '"?')) return;
    delete OPENINGS[k];
    saveStorage();
    renderMenu();
}

// =====================================================
// TRAINER
// =====================================================
function startTraining(k) {
    currentOpening = OPENINGS[k];
    currentOpeningKey = k; // FIX: Store key for self-reference check
    userColor = currentOpening.color;
    currentPath = [];
    showScreen('trainerScreen');
    document.getElementById('openingTitle').textContent = currentOpening.name;
    document.getElementById('openingSubtitle').textContent = 'Playing as ' + userColor[0].toUpperCase() + userColor.slice(1);
    
    const backBtn = document.getElementById('trainerBackBtn');
    backBtn.textContent = isPreviewMode ? '‚Üê Back to Editor' : '‚Üê Back to Openings';
    
    renderTrainer();
}

function handleTrainerBack() {
    if (isPreviewMode) {
        isPreviewMode = false;
        showScreen('builderScreen');
    } else {
        goToMenu();
    }
}

function getTrainerNode() {
    let n = currentOpening.tree;
    for (const id of currentPath) {
        if (n.isChoice && n.choices) {
            const c = n.choices.find(x => x.id === id);
            if (c) n = c;
        } else if (n.children) {
            const c = n.children.find(x => x.id === id);
            if (c) {
                if (c.player === userColor) { n = c; } 
                else { n = c.response || c; }
            }
        }
    }
    return n;
}

function getTrainerOpts(n) {
    if (n.isChoice && n.choices) return { type: 'choices', opts: n.choices };
    if (n.children?.length) return { type: 'moves', opts: n.children };
    if (n.player === userColor && n.response) {
        return { type: 'moves', opts: [n.response] };
    }
    return { type: 'end', opts: [] };
}

function getTrainerHistory() {
    let h = [{ m: currentOpening.tree.move, p: currentOpening.tree.player, isChoice: false }];
    let n = currentOpening.tree;
    for (const id of currentPath) {
        if (n.isChoice && n.choices) {
            const c = n.choices.find(x => x.id === id);
            if (c) { h.push({ m: c.move, p: userColor, isChoice: true }); n = c; }
        } else if (n.children) {
            const c = n.children.find(x => x.id === id);
            if (c) {
                h.push({ m: c.move, p: c.player });
                if (c.player === userColor) { n = c; }
                else {
                    if (c.response) { h.push({ m: c.response.move, p: c.response.player, isChoice: c.response.isChoice }); n = c.response; }
                }
            }
        }
    }
    return h;
}

function renderTrainer() {
    const n = getTrainerNode(), o = getTrainerOpts(n), h = getTrainerHistory(), mc = Math.ceil(h.length / 2);
    
    document.getElementById('moveHistory').innerHTML = h.map(x => 
        `<span class="move-tag ${x.p === 'white' ? 'white-move' : 'black-move'} ${x.isChoice ? 'choice' : ''}">${x.m}</span>`
    ).join('');
    
    const isU = n.player === userColor || n.isChoice;
    // FIX: Pass currentOpeningKey instead of name
    const transHTML = getTranspositionHTML(currentOpeningKey);

    let html = `
        <div class="move-label">
            <div class="move-dot ${isU ? 'your-move' : 'opponent-move'}"></div>
            <span class="${isU ? 'your-move' : 'opponent-move'}">${isU ? 'Your Move' : 'Opponent\'s Move'}</span>
        </div>
        <div class="current-move ${isU ? '' : 'opponent'}">
            <h2>${n.move}</h2>
        </div>
        <p class="explanation">${n.explanation || ''}</p>
        ${transHTML}
        `;
    
    if (o.type === 'choices') {
        html += `<div class="options-section">
            <div class="options-label"><div class="move-dot your-move"></div><span>Choose your approach:</span></div>
            <div class="choices-grid">`;
        o.opts.forEach(x => {
            html += `<button class="choice-card ${x.color || 'blue'}" onclick="trainerSelect('${x.id}')">
                <h4>${x.move}</h4><p class="name">${x.name || ''}</p><p class="style">${x.style || ''}</p>
            </button>`;
        });
        html += '</div></div>';
    } else if (o.type === 'moves') {
        const childrenAreYourMoves = o.opts.length > 0 && o.opts[0].player === userColor;
        if (childrenAreYourMoves) {
            html += `<div class="options-section">
                <div class="options-label"><div class="move-dot your-move"></div><span>Your response...</span></div>`;
            o.opts.forEach(x => {
                const lbl = x.label?.includes('Blunder') ? 'blunder' : (x.label === 'Main Line' || x.label === 'Main') ? 'main' : '';
                html += `<button class="option-btn" onclick="trainerSelect('${x.id}')">
                    <div><span class="move-text">${x.move}</span>${x.label ? `<span class="label ${lbl}">${x.label}</span>` : ''}</div>
                    <span class="arrow">‚Üí</span>
                </button>`;
            });
            html += '</div>';
        } else {
            const opp = userColor === 'white' ? 'Black' : 'White';
            html += `<div class="options-section">
                <div class="options-label"><div class="move-dot opponent-move"></div><span>${opp} might play...</span></div>`;
            o.opts.forEach(x => {
                const lbl = x.label?.includes('Blunder') ? 'blunder' : (x.label === 'Main Line' || x.label === 'Main') ? 'main' : '';
                html += `<button class="option-btn" onclick="trainerSelect('${x.id}')">
                    <div><span class="move-text">${x.move}</span>${x.label ? `<span class="label ${lbl}">${x.label}</span>` : ''}</div>
                    <span class="arrow">‚Üí</span>
                </button>`;
            });
            html += '</div>';
        }
    } else {
        html += `<div class="end-card"><div class="icon">üéØ</div><h3>End of Line</h3><p>Move ${mc} reached</p></div>`;
    }
    
    document.getElementById('currentMoveCard').innerHTML = html;
    document.getElementById('controls').innerHTML = currentPath.length ? 
        `<button class="control-btn secondary" onclick="trainerBack()">‚Üê Back</button>
         <button class="control-btn secondary" onclick="trainerReset()">Start Over</button>` : '';
    document.getElementById('progressDots').innerHTML = Array.from({length: 12}, (_, i) => 
        `<div class="progress-dot ${i < mc ? 'active' : ''}"></div>`).join('');
}

function trainerSelect(id) { currentPath.push(id); renderTrainer(); }
function trainerBack() { currentPath.pop(); renderTrainer(); }
function trainerReset() { currentPath = []; renderTrainer(); }

// =====================================================
// BUILDER LOGIC
// =====================================================

function showBuilder() {
    builderColor = 'white';
    builderTree = null;
    builderPath = [];
    editingKey = null;
    document.getElementById('openingName').value = '';
    document.getElementById('openingDesc').value = '';
    document.getElementById('builderTitle').textContent = 'üõ†Ô∏è Create Opening';
    document.getElementById('saveBtn').textContent = 'Save';
    document.getElementById('downloadCurrentBtn').style.display = 'none';
    updateColorToggle();
    switchTab('build');
    showScreen('builderScreen');
    renderBuilder();
}

function editOpening(key) {
    const opening = OPENINGS[key];
    if (!opening) return;
    builderColor = opening.color;
    builderTree = JSON.parse(JSON.stringify(opening.tree)); 
    builderPath = [];
    editingKey = key;
    document.getElementById('openingName').value = opening.name;
    document.getElementById('openingDesc').value = opening.description || '';
    document.getElementById('builderTitle').textContent = '‚úèÔ∏è Edit Opening';
    document.getElementById('saveBtn').textContent = 'Update';
    document.getElementById('downloadCurrentBtn').style.display = 'block';
    updateColorToggle();
    switchTab('build');
    showScreen('builderScreen');
    renderBuilder();
}

function confirmExitBuilder() {
    if (builderTree && !confirm('Exit without saving?')) return;
    editingKey = null;
    goToMenu();
}

function switchTab(t) {
    document.getElementById('tabBuild').classList.toggle('active', t === 'build');
    document.getElementById('tabJson').classList.toggle('active', t === 'json');
    document.getElementById('buildTab').style.display = t === 'build' ? 'block' : 'none';
    document.getElementById('jsonTab').style.display = t === 'json' ? 'block' : 'none';
    if (t === 'json') {
        if (builderTree) { document.getElementById('jsonOut').value = JSON.stringify(buildOpeningObj(), null, 2); } 
        else { const template = builderColor === 'white' ? JSON_TEMPLATE_WHITE : JSON_TEMPLATE_BLACK; document.getElementById('jsonOut').value = JSON.stringify(template, null, 2); }
    }
}

function setColor(c) {
    if (editingKey) { alert('Cannot change color when editing.'); return; }
    builderColor = c;
    updateColorToggle();
    builderTree = null;
    builderPath = [];
    renderBuilder();
}

function updateColorToggle() {
    document.querySelectorAll('.color-option').forEach(el => 
        el.classList.toggle('selected', el.classList.contains(builderColor)));
}

function getBuilderPosition() {
    if (!builderTree) return { node: null, context: 'empty' };
    let node = builderTree;
    let parent = null, childRef = null;
    for (const step of builderPath) {
        if (step.type === 'child') {
            if (!node.children) return { node: null, context: 'error' };
            const child = node.children.find(c => c.id === step.id);
            if (!child) return { node: null, context: 'error' };
            parent = node; childRef = child; node = child;
        } else if (step.type === 'response') {
            if (!childRef || !childRef.response) return { node: null, context: 'error' };
            node = childRef.response; childRef = null;
        } else if (step.type === 'choice') {
            if (!node.isChoice || !node.choices) return { node: null, context: 'error' };
            const choice = node.choices.find(c => c.id === step.id);
            if (!choice) return { node: null, context: 'error' };
            node = choice;
        }
    }
    let context;
    if (builderPath.length === 0) { context = (node.player === builderColor) ? 'your-move' : 'opponent-move-root'; } 
    else {
        const lastStep = builderPath[builderPath.length - 1];
        if (lastStep.type === 'child') { context = (node.player === builderColor) ? 'your-move-as-child' : 'opponent-move'; } 
        else if (lastStep.type === 'response' || lastStep.type === 'choice') { context = 'your-move'; }
    }
    return { node, context, parent, childRef };
}

function getCurrentChildRef() {
    if (!builderTree || builderPath.length === 0) return null;
    let node = builderTree, childRef = null;
    for (const step of builderPath) {
        if (step.type === 'child') {
            if (!node.children) return null;
            childRef = node.children.find(c => c.id === step.id);
            node = childRef;
        } else if (step.type === 'response') { node = childRef.response; childRef = null; } 
        else if (step.type === 'choice') { node = node.choices.find(c => c.id === step.id); childRef = null; }
    }
    return childRef;
}

function getMoveNumber() {
    if (!builderTree) return 1;
    let num = 1, node = builderTree, childRef = null;
    for (const step of builderPath) {
        if (step.type === 'child') {
            childRef = node.children?.find(c => c.id === step.id);
            if (childRef) node = childRef;
        } else if (step.type === 'response') {
            if (childRef?.response) { num++; node = childRef.response; childRef = null; }
        } else if (step.type === 'choice') {
            const choice = node.choices?.find(c => c.id === step.id);
            if (choice) node = choice;
        }
    }
    return num;
}

function renderBuilder() {
    const content = document.getElementById('builderContent');
    const pos = getBuilderPosition();
    if (!builderTree) {
        const isWhite = builderColor === 'white';
        content.innerHTML = `<div class="empty-state"><div class="icon">‚ôüÔ∏è</div><p>Start by adding ${isWhite ? 'your first move' : 'White\'s opening move'}</p></div>
            <div class="add-form"><div class="add-form-title">${isWhite ? 'Your First Move (White)' : 'White\'s First Move'}</div>
                <div class="form-group"><input type="text" id="newMove" placeholder="e.g., e4 or d4"></div>
                ${isWhite ? `<div class="form-group"><input type="text" id="newExpl" placeholder="Explanation"></div>` : ''}
                <button class="btn btn-primary" onclick="addFirstMove()">Add Move</button></div>`;
        setupEnter(); return;
    }
    if (!pos.node) return;
    const node = pos.node, opponent = builderColor === 'white' ? 'Black' : 'White', you = builderColor === 'white' ? 'White' : 'Black';
    let pathParts = [builderTree.move], tempNode = builderTree, tempChild = null;
    for (const step of builderPath) {
        if (step.type === 'child') {
            tempChild = tempNode.children?.find(c => c.id === step.id);
            if (tempChild) { pathParts.push(tempChild.move); tempNode = tempChild; }
        } else if (step.type === 'response') {
            if (tempChild?.response) { pathParts.push(tempChild.response.move); tempNode = tempChild.response; tempChild = null; }
        } else if (step.type === 'choice') {
            const choice = tempNode.choices?.find(c => c.id === step.id);
            if (choice) { pathParts.push(choice.move); tempNode = choice; }
        }
    }
    const transHTML = getTranspositionHTML(document.getElementById('openingName').value || 'Current');
    let html = builderPath.length > 0 ? `<button class="btn btn-secondary" onclick="builderBack()" style="margin-bottom:16px">‚Üê Back</button>` : '';
    html += `<div class="path-display"><span class="current">${pathParts.join(' ‚Üí ')}</span></div>`;
    if (pos.context.includes('your-move')) html += renderYourMoveView(node, opponent, transHTML);
    else html += renderOpponentMoveView(node, you, pos.context === 'opponent-move-root', transHTML);
    content.innerHTML = html;
    setupEnter();
    setupLabelDropdown();
}

function renderYourMoveView(node, opponent, transHTML) {
    let html = '';
    if (node.isChoice) {
        html += `<div class="position-card"><div class="position-label">Choice Point</div><div class="position-move">${node.move}</div>${node.explanation?`<div class="position-expl">${node.explanation}</div>`:''}</div>${transHTML}`;
        if (node.choices?.length) {
            html += `<p class="section-title">Your Options</p><div class="choices-grid">`;
            node.choices.forEach(c => {
                html += `<div class="choice-card ${c.color||'blue'}"><div onclick="navigateToChoice('${c.id}')"><h4>${c.move}</h4><p class="name">${c.name||''}</p><p class="style">${c.style||''}</p></div><button class="delete-item-btn" onclick="deleteChoice('${c.id}')">√ó</button></div>`;
            });
            html += '</div>';
        }
        html += renderAddChoiceForm();
    } else {
        html += `<div class="position-card"><div class="position-label">Your Move</div><div class="position-move">${node.move}</div>${node.explanation?`<div class="position-expl">${node.explanation}</div>`:''}</div>${transHTML}`;
        html += renderEditExplanation(node);
        if (node.children?.length) {
            html += `<p class="section-title">${opponent}'s Responses</p><div class="response-list">`;
            node.children.forEach(c => {
                html += `<div class="response-item"><div onclick="navigateToChild('${c.id}')" style="flex:1"><span class="move">${c.move}</span>${c.label?`<span class="tag">${c.label}</span>`:''}</div><button class="delete-item-btn" onclick="deleteChildFromList('${c.id}')">√ó</button><span class="arrow">‚Üí</span></div>`;
            });
            html += '</div>';
        }
        html += `<div class="add-form"><div class="add-form-title">Add ${opponent}'s Response</div><div class="form-group"><input type="text" id="newMove" placeholder="e.g. e5"></div><div class="form-group"><select id="newLabel">${LABEL_OPTIONS.map(l=>`<option value="${l}">${l||'(No label)'}</option>`).join('')}</select></div><div class="form-group" id="customLabelGroup" style="display:none"><input type="text" id="customLabel"></div><button class="btn btn-purple" onclick="addChildMove()">+ Add Response</button></div>`;
    }
    return html;
}

function renderOpponentMoveView(node, you, isRoot, transHTML) {
    let html = `<div class="position-card opponent"><div class="position-label">Opponent's Move</div><div class="position-move">${node.move}</div>${node.label?`<div class="position-expl">Label: ${node.label}</div>`:''}</div>${transHTML}`;
    if (isRoot) {
        if (node.children?.length) {
            html += `<p class="section-title">Your Responses</p><div class="response-list">`;
            node.children.forEach(c => {
                html += `<div class="response-item"><div onclick="navigateToChild('${c.id}')" style="flex:1"><span class="move">${c.move}</span></div><button class="delete-item-btn" onclick="deleteChildFromRoot('${c.id}')">√ó</button><span class="arrow">‚Üí</span></div>`;
            });
            html += '</div>';
        }
        html += `<div class="add-form"><div class="add-form-title">Add Your (${you}) Response</div><div class="form-group"><input type="text" id="newMove"></div><div class="form-group"><select id="newLabel">${LABEL_OPTIONS.map(l=>`<option value="${l}">${l||'(No label)'}</option>`).join('')}</select></div><div class="form-group" id="customLabelGroup" style="display:none"><input type="text" id="customLabel"></div><div class="form-group"><input type="text" id="newExpl" placeholder="Explanation"></div><button class="btn btn-primary" onclick="addYourResponseAtRoot()">Add Response</button></div>`;
        return html;
    }
    const childRef = getCurrentChildRef();
    if (childRef?.response) {
        const resp = childRef.response;
        html += `<p class="section-title">Your Response${resp.isChoice?' (Choice Point)':''}</p><div class="your-response-card" onclick="navigateToResponse()"><div style="flex:1"><div class="label">Tap to continue</div><div class="move">${resp.move}</div></div><span class="arrow">‚Üí</span></div>`;
        if (!resp.isChoice) html += `<div class="add-form choice-form"><div class="add-form-title">Add Alternative</div><div class="form-group"><input type="text" id="altMove" placeholder="Move"></div><div class="form-group"><input type="text" id="altName" placeholder="Name"></div><div class="form-group"><input type="text" id="altStyle" placeholder="Style"></div><div class="form-group"><div class="style-colors"><div class="style-color red" onclick="selectStyleColor('red')">Aggressive</div><div class="style-color blue" onclick="selectStyleColor('blue')">Solid</div></div></div><button class="btn btn-purple" onclick="addAlternativeResponse()">+ Add Alternative</button></div>`;
        html += `<div class="detail-actions"><button class="btn btn-danger" onclick="deleteCurrentBranch()">Delete Branch</button></div>`;
    } else {
        html += `<div class="add-form"><div class="add-form-title">Add Your (${you}) Response</div><div class="toggle-row"><span class="toggle-label">Create choice point</span><div class="toggle-switch" id="choiceToggle" onclick="toggleChoiceMode()"></div></div><div id="singleResponseFields"><div class="form-group"><input type="text" id="newMove" placeholder="Move"></div><div class="form-group"><input type="text" id="newExpl" placeholder="Explanation"></div><button class="btn btn-primary" onclick="addResponse()">Add Response</button></div><div class="choice-fields" id="choicePointFields"><div class="form-group"><input type="text" id="choiceMove" placeholder="Move"></div><div class="form-group"><input type="text" id="choiceName" placeholder="Name"></div><div class="form-group"><div class="style-colors"><div class="style-color red selected" onclick="selectStyleColor('red')">Aggressive</div><div class="style-color blue" onclick="selectStyleColor('blue')">Solid</div></div></div><button class="btn btn-purple" onclick="addChoicePointResponse()">Create Choice Point</button></div></div><div class="detail-actions"><button class="btn btn-danger" onclick="deleteCurrentBranch()">Delete Branch</button></div>`;
    }
    return html;
}

function renderEditExplanation(node) {
    return `<div class="edit-explanation"><label>Explanation</label><textarea id="editExpl">${node.explanation || ''}</textarea><button class="btn btn-secondary" onclick="saveExplanation()">Save</button></div>`;
}

function renderAddChoiceForm() {
    return `<div class="add-form choice-form"><div class="add-form-title">Add Option</div><div class="form-group"><input type="text" id="choiceMove" placeholder="Move"></div><div class="form-group"><input type="text" id="choiceName" placeholder="Name"></div><div class="form-group"><div class="style-colors"><div class="style-color red" onclick="selectStyleColor('red')">Aggressive</div><div class="style-color blue selected" onclick="selectStyleColor('blue')">Solid</div></div></div><button class="btn btn-purple" onclick="addChoiceToExisting()">+ Add Option</button></div>`;
}

// =====================================================
// UTILS & EVENTS
// =====================================================
function setupEnter() {
    setTimeout(() => {
        const input = document.getElementById('newMove') || document.getElementById('choiceMove');
        if (input) { input.focus(); input.addEventListener('keypress', e => { if (e.key === 'Enter') document.querySelectorAll('.add-form .btn')[0].click(); }); }
    }, 50);
}

function setupLabelDropdown() {
    const select = document.getElementById('newLabel'), grp = document.getElementById('customLabelGroup');
    if (select && grp) select.addEventListener('change', () => grp.style.display = select.value === 'Custom' ? 'block' : 'none');
}

function toggleChoiceMode() {
    const t = document.getElementById('choiceToggle'); t.classList.toggle('active');
    document.getElementById('singleResponseFields').style.display = t.classList.contains('active') ? 'none' : 'block';
    document.getElementById('choicePointFields').style.display = t.classList.contains('active') ? 'block' : 'none';
}

let selectedStyleColor = 'red';
function selectStyleColor(c) { selectedStyleColor = c; document.querySelectorAll('.style-color').forEach(el => el.classList.toggle('selected', el.classList.contains(c))); }

// Navigation Actions
function navigateToChild(id) { builderPath.push({ type: 'child', id }); renderBuilder(); }
function navigateToResponse() { builderPath.push({ type: 'response' }); renderBuilder(); }
function navigateToChoice(id) { builderPath.push({ type: 'choice', id }); renderBuilder(); }
function builderBack() { builderPath.pop(); renderBuilder(); }

// Builder Actions
function addFirstMove() {
    const m = document.getElementById('newMove').value.trim(), e = document.getElementById('newExpl')?.value.trim()||'';
    if(!m)return; builderTree={id:'root',move:'1. '+m,player:'white',explanation:builderColor==='white'?e:'',children:[]}; renderBuilder();
}
function addChildMove() {
    const m=document.getElementById('newMove').value.trim(); if(!m)return;
    let l=document.getElementById('newLabel')?.value||''; if(l==='Custom')l=document.getElementById('customLabel')?.value||'';
    const num=getMoveNumber(), opp=builderColor==='white'?'black':'white', not=opp==='black'?`${num}... ${m}`:`${num}. ${m}`;
    const child={id:'c'+Date.now(),move:not,player:opp,label:l,response:null};
    const pos=getBuilderPosition(); if(!pos.node.children)pos.node.children=[]; pos.node.children.push(child);
    builderPath.push({type:'child',id:child.id}); renderBuilder();
}
function addResponse() {
    const m=document.getElementById('newMove').value.trim(); if(!m)return;
    const ref=getCurrentChildRef(), num=getMoveNumber()+1, not=builderColor==='white'?`${num}. ${m}`:`${num}... ${m}`;
    ref.response={id:'r'+Date.now(),move:not,player:builderColor,explanation:document.getElementById('newExpl').value,children:[]};
    builderPath.push({type:'response'}); renderBuilder();
}
function addChoicePointResponse() {
    const m=document.getElementById('choiceMove').value.trim(); if(!m)return;
    const ref=getCurrentChildRef(), num=getMoveNumber()+1, not=builderColor==='white'?`${num}. ${m}`:`${num}... ${m}`;
    ref.response={id:'cp'+Date.now(),move:'Choose Style',player:builderColor,isChoice:true,choices:[{
        id:'ch'+Date.now(),move:not,name:document.getElementById('choiceName').value,style:document.getElementById('choiceStyle')?.value,color:selectedStyleColor,children:[]
    }]};
    builderPath.push({type:'response'}); renderBuilder();
}
function addChoiceToExisting() {
    const m=document.getElementById('choiceMove').value.trim(); if(!m)return;
    const pos=getBuilderPosition(), num=getMoveNumber(), not=builderColor==='white'?`${num}. ${m}`:`${num}... ${m}`;
    pos.node.choices.push({id:'ch'+Date.now(),move:not,name:document.getElementById('choiceName').value,color:selectedStyleColor,children:[]}); renderBuilder();
}
function saveExplanation() { getBuilderPosition().node.explanation = document.getElementById('editExpl').value; renderBuilder(); }
function deleteCurrentBranch() { if(!confirm('Delete branch?'))return; 
    if(builderPath.length===0)builderTree=null; else {
        const last=builderPath.pop(), prev=getBuilderPosition().node;
        if(last.type==='child') prev.children=prev.children.filter(c=>c.id!==last.id);
        else if(last.type==='choice') prev.choices=prev.choices.filter(c=>c.id!==last.id);
    } renderBuilder();
}
function deleteChildFromList(id) { const n=getBuilderPosition().node; n.children=n.children.filter(c=>c.id!==id); renderBuilder(); }
function deleteChildFromRoot(id) { builderTree.children=builderTree.children.filter(c=>c.id!==id); renderBuilder(); }
function addYourResponseAtRoot() {
    const m=document.getElementById('newMove').value.trim(); if(!m)return;
    let l=document.getElementById('newLabel')?.value||''; if(l==='Custom')l=document.getElementById('customLabel')?.value||'';
    const child={id:'c'+Date.now(),move:'1... '+m,player:builderColor,label:l,explanation:document.getElementById('newExpl').value,children:[]};
    if(!builderTree.children)builderTree.children=[]; builderTree.children.push(child);
    builderPath.push({type:'child',id:child.id}); renderBuilder();
}
function deleteChoice(id) { const n=getBuilderPosition().node; n.choices=n.choices.filter(c=>c.id!==id); renderBuilder(); }
function addAlternativeResponse() {
    const m=document.getElementById('altMove').value.trim(); if(!m)return;
    const ref=getCurrentChildRef(), old=ref.response, num=getMoveNumber()+1;
    const newChoice={id:'ch'+Date.now(),move:builderColor==='white'?`${num}. ${m}`:`${num}... ${m}`,name:document.getElementById('altName').value,color:selectedStyleColor,children:[]};
    const oldChoice={id:'ch_old'+Date.now(),move:old.move,name:'Original',color:'blue',children:old.children||[]};
    ref.response={id:'cp'+Date.now(),move:'Choose Style',player:builderColor,isChoice:true,choices:[oldChoice,newChoice]};
    renderBuilder();
}

// IO
function buildOpeningObj() {
    return { name:document.getElementById('openingName').value||'Opening', color:builderColor, description:document.getElementById('openingDesc').value, startingMoves:getStartingMoves(), tree:builderTree };
}
function getStartingMoves() {
    if(!builderTree)return''; let m=[builderTree.move],n=builderTree;
    while(n.children?.length && m.length<6) { const c=n.children[0]; m.push(c.move); 
        if(c.response){n=c.response.isChoice?c.response.choices[0]:c.response; m.push(n.move);} else break; }
    return m.join(' ');
}
function previewOpening() { if(!builderTree)return; OPENINGS['_preview']=buildOpeningObj(); isPreviewMode=true; startTraining('_preview'); }
function saveOpening() {
    if(!builderTree)return alert('Add moves first'); const o=buildOpeningObj();
    const k=editingKey || (o.name.toLowerCase().replace(/[^a-z0-9]/g,'_')+'_'+Date.now());
    OPENINGS[k]=o; saveStorage(); alert('Saved!'); editingKey=null; goToMenu();
}
function copyJson() { navigator.clipboard.writeText(document.getElementById('jsonOut').value); alert('Copied!'); }
function importJson() { try { const o=JSON.parse(document.getElementById('jsonIn').value); OPENINGS['imp_'+Date.now()]=o; saveStorage(); alert('Imported!'); goToMenu(); } catch(e){alert('Invalid JSON');} }
function downloadOpening(k) { downloadObj(OPENINGS[k], OPENINGS[k].name); }
function downloadCurrentOpening() { downloadObj(buildOpeningObj(), document.getElementById('openingName').value); }
function downloadObj(o, n) {
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(o,null,2)],{type:'application/json'}));
    a.download=n.replace(/[^a-z0-9]/g,'-')+'.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function triggerFileUpload() { document.getElementById('fileUploadInput').click(); }
function handleFileUpload(e) { 
    const r=new FileReader(); r.onload=ev=>{try{const o=JSON.parse(ev.target.result);OPENINGS['imp_'+Date.now()]=o;saveStorage();alert('Imported!');renderMenu();}catch{alert('Error');}};
    if(e.target.files[0])r.readAsText(e.target.files[0]); e.target.value='';
}
function showUrlImport() { document.getElementById('urlImportSection').style.display='block'; }
function hideUrlImport() { document.getElementById('urlImportSection').style.display='none'; }
async function importFromUrl() {
    try { const r=await fetch(document.getElementById('importUrl').value); const o=await r.json(); OPENINGS['imp_'+Date.now()]=o; saveStorage(); alert('Imported!'); hideUrlImport(); renderMenu(); } catch(e){alert('Error fetching');}
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>